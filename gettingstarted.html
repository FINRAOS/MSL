<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mock Service Layer - Getting Started</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
	<link href="./css/bootstrap-theme.min.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
    </style>
    <link href="./css/prettify.css" rel="stylesheet">
    <script src="./js/prettify.js"></script>
    <script src="./js/run_prettify.js"></script>
    <script src="./js/jquery.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script>
  		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  		ga('create', 'UA-46470036-1', 'finraos.github.io');
  		ga('send', 'pageview');
	</script>
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
          	<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          		<span class="sr-only">Toggle navigation</span>
            	<span class="icon-bar"></span>
            	<span class="icon-bar"></span>
            	<span class="icon-bar"></span>
          	</button>
          	<a class="navbar-brand" href="./index.html" style="color: white"><span style="color: #F38D26">M</span><span style="color: #BFBFBF">S</span><span style="color: #F38D26">L</span></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="./gettingstarted.html">Getting Started</a></li>
              <li><a href="./apidoc.html">API Doc</a></li>
              <li><a href="./contribute.html">Development</a></li>              
              <li><a href="./about.html">About</a></li>
              <li><a href="./comingsoon.html">Coming Soon</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      
    </div>

	<div class="container">
		<div class="page-header">
			<h1>Getting Started</h1>
		</div>
		<h3>Starting MSL Server</h3>
		<p>First you need to have Node.JS installed, go to <a href="http://nodejs.org" target="_blank">nodejs.org</a> for more about Node.JS
		<br>Once you have Node installed, you can install <a href="https://www.npmjs.org/package/msl-server">MSL Server</a> from npm to start launching your app locally!
		<br>

		<div class="panel panel-default">
			<div class="panel-heading">
			<h3 class="panel-title">Local install of MSL Server npm package</h3>
			</div>
			<div class="panel-body">
					<b>Use the following command to install MSL Server</b>
		<div>
      		<pre class="prettyprint"><code>npm install msl-server</code></pre>
		</div>
		<br>After the install, you can now launch the server by using the command below
		<div>
      		<pre class="prettyprint"><code>./node_modules/msl-server/bin/msl [options]</code></pre>
		</div>
		</div>
		</div>

		<div class="panel panel-default">
			<div class="panel-heading">
			<h3 class="panel-title">Global install of MSL Server npm package</h3>
			</div>
			<div class="panel-body">
					<b>Use the following command to install MSL Server globally</b>
		<div>
      		<pre class="prettyprint"><code>npm install -g msl-server</code></pre>
		</div>
		<br>After the install, you can now launch the server by using the command below
		<div>
      		<pre class="prettyprint"><code>msl [options]</code></pre>
		</div>
		</div>
		</div>		
		
				<div class="panel panel-default">
			<div class="panel-heading">
			<h3 class="panel-title">Availabe options for MSL Server</h3>
			</div>
			<div class="panel-body">
		<b>--port</b>  =>  specify the port that server will be listening on local host, default is 8000.
		<br><b>--basedir</b>  =>  specify the root directory(absolute path) of the app you want to launch locally, default is the directory where you run the command.
		<br><b>--debug</b>  =>  specify whether to output log in console or not, default is false.
		<br>
		<br><b>An example how the options work</b>
		<div>
      		<pre class="prettyprint"><code>msl --port=8000 --basedir=/approot/ --debug=true</code></pre>
		</div>
		</div>
		</div>
		<b><i>*To validate whether your app is running, open up your favorite browser and navigate to http://localhost:&lt;PORT&gt;/&lt;YOUR_FILE&gt;</i></b>
		<br>
		</p>
		<br>
		<h3>Choosing Client</h3>
		<p>Next, you can install the client that will be used to interact with the server. The client is used to set up the mock responses for the requests that will be made by your application running locally on the server.  The client is also used to tell the server which requests to intercept for validation.  MSL currently supports 3 clients with more language bindings coming soon.</p>
	  	
	  	<div class="panel-group" id="accordion">
	  	  <div class="panel panel-default">
			<div class="panel-heading">
			  <h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
				  Node Client
				</a>
			  </h4>
			</div>
			<div id="collapseOne" class="panel-collapse collapse in">
			  <div class="panel-body">
				To use the Node client, first install <a href="https://www.npmjs.org/package/msl-client">MSL Client</a> from your working directory using npm
				<div>
      				<pre class="prettyprint"><code>npm install msl-client</code></pre>
				</div>
				<br>
				After installing, you can now use it within your Node script by requiring 'msl-client'
				<div>
      				<pre class="prettyprint"><code>var msl = require('msl-client');</code></pre>
				</div>
				<br>
				<b>(Full documentation with example coming soon!)</b>
			  </div>
			</div>
		  </div>
		  
		  <div class="panel panel-default">
			<div class="panel-heading">
			  <h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
				  Java Client
				</a>
			  </h4>
			</div>
			<div id="collapseThree" class="panel-collapse collapse">
			  <div class="panel-body">
					To start things off, you will need to create a new Java project in any IDE and get the necessary libraries. If you create a maven project, then you will just need to include the following dependencies:
	<p><br>
      	<b>POM Snippet:</b>
      	<div>
      		<pre class="prettyprint">
<code>   &lt;dependency&gt;
      &lt;groupId&gt;org.finra.msl&lt;/groupId&gt;
      &lt;artifactId&gt;msl-client-java&lt;/artifactId&gt;
      &lt;version&gt;1.0.0&lt;/version&gt;
   &lt;/dependency&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.finra.jtaf&lt;/groupId&gt;
      &lt;artifactId&gt;jtaf-extwebdriver&lt;/artifactId&gt;
      &lt;version&gt;1.3&lt;/version&gt;
   &lt;/dependency&gt;</code></pre></div>
      </p>
					These will get you the Java client API and the <a href="http://finraos.github.io/JTAF-ExtWebDriver">ExtWebDriver</a> that will be used in this example to interact with the elements on the page. Along with these libraries, you should also include JUnit 4 which can be
					done as shown <a href="https://github.com/junit-team/junit/wiki/Download-and-Install">here</a>.<br>
					<br>Using the sample app that is on the github page, this example will test some of the core functionality - setting up a mock response using both plain text and a template, getting intercepted
					HTTP requests for both POST and GET requests, and unregistering a mock when it is no longer needed.<br>
<br><pre class="prettyprint">
<code>package org.finra.msl.client;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.finra.jtaf.ewd.ExtWebDriver;
import org.finra.jtaf.ewd.session.SessionManager;
import org.finra.jtaf.ewd.widget.element.Element;
import org.finra.jtaf.ewd.widget.element.InteractiveElement;
import org.finra.msl.client.MockAPI;
import org.finra.msl.client.MockAPI.XHR;
import org.junit.AfterClass;
import org.junit.Assert;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;

/**
 * Tests for msl-client-java and msl-server
 */
public class MockAPITest {
    public static ExtWebDriver ewd;

    @BeforeClass
    public static void setUp() throws Exception {
        // Get a new ExtWebDriver session
        ewd = SessionManager.getInstance().getNewSession();
    }

    @Before
    public void openApp() {
        // Open the test application
        ewd.open("http://localhost:8001/index.html");
    }

    @Test
    public void testTextResponse() throws Exception {
        // Create object for autocomplete element
        InteractiveElement autocomplete = new InteractiveElement(".//*[@id=\"autocomplete\"]");

        // Set up the object that contains our response configuration
        Map<String, Object> configurations = new HashMap<String, Object>();
        configurations.put("requestPath", "/services/getlanguages");
        configurations.put("responseText", "{\"label\":\"Java\"},{\"label\":\"Perl\"}");
        configurations.put("contentType", "application/json");
        configurations.put("eval",
                "function (req,responseText) { return '[' + responseText + ']'; }");
        configurations.put("statusCode", "200");
        configurations.put("delayTime", "0");

        // Setting up the mock response using the configuration
        MockAPI.setMockRespond("localhost", 8001, configurations);

        // Triggering the event
        autocomplete.type("J");

        Element dropdown = new Element(".//ul[contains(@class, \"ui-autocomplete\")]");
        dropdown.waitForVisible();

        // Getting all of the options from the dropdown menu to be validated
        List<WebElement> elements = ewd.findElements(By
                .xpath(".//ul[contains(@class, \"ui-autocomplete\")]/li"));

        // Verify that the options are from the mocked response
        Assert.assertEquals("Java", elements.get(0).getText());
        Assert.assertEquals("Perl", elements.get(1).getText());
    }

    @Test
    public void testTemplateResponse() throws Exception {
        MockAPI.registerTemplate("localhost", 8001,
                "[{\"label\":\"{{param1}}\"},{\"label\":\"{{param2}}\"}]", "example");

        InteractiveElement autocomplete = new InteractiveElement(".//*[@id=\"autocomplete\"]");

        Map<String, Object> configurations = new HashMap<String, Object>();
        configurations.put("requestPath", "/services/getlanguages");
        configurations.put("contentType", "application/json");
        configurations.put("statusCode", "200");
        configurations.put("delayTime", "0");

        Map<String, String> keyValue = new HashMap<String, String>();
        keyValue.put("param1", "German");
        keyValue.put("param2", "English");
        configurations.put("keyValues", keyValue);
        configurations.put("id", "example");

        // Setting up the mock response using the configuration
        MockAPI.setMockRespond("localhost", 8001, configurations);

        // Triggering the event
        autocomplete.type("J");

        Element dropdown = new Element(".//ul[contains(@class, \"ui-autocomplete\")]");
        dropdown.waitForVisible();

        // Getting all of the options from the dropdown menu to be validated
        List<WebElement> elements = ewd.findElements(By
                .xpath(".//ul[contains(@class, \"ui-autocomplete\")]/li"));

        // Verify that the options are from the mocked response
        Assert.assertEquals("German", elements.get(0).getText());
        Assert.assertEquals("English", elements.get(1).getText());
    }

    @Test
    public void testGetIntercept() throws Exception {
        MockAPI.setInterceptXHR("localhost", 8001, "/services/getservice");

        InteractiveElement input = new InteractiveElement(".//*[@id=\"getInput\"]");
        input.type("GET Example");

        InteractiveElement button = new InteractiveElement(".//*[@id=\"getRequest\"]");
        button.click();

        // Due to WebDriver operating too quickly sometimes, it is held up so
        // that the web-server has enough time to intercept
        Thread.sleep(5);

        // Get the HTTP requests that have been intercepted
        XHR[] interceptedXHR = MockAPI.getInterceptedXHR("localhost", 8001, "/services/getservice");

        // Verify that the intercepted HTTP request is the one we are looking
        // for by checking its content
        Assert.assertEquals("GET", interceptedXHR[0].getMethodType());
        Assert.assertEquals("/services/getservice?term=GET+Example", interceptedXHR[0].getUrl());
        Assert.assertEquals("GET Example", interceptedXHR[0].getQueryString().get("term"));
    }

    @Test
    public void testPostIntercept() throws Exception {
        // Setting
        MockAPI.setInterceptXHR("localhost", 8001, "/services/postservice");

        InteractiveElement input = new InteractiveElement(".//*[@id=\"output-box\"]");
        input.type("POST Example");

        InteractiveElement button = new InteractiveElement(".//*[@id=\"postRequest\"]");
        button.click();

        // Due to WebDriver operating too quickly sometimes, it is held up so
        // that the web-server has enough time to intercept
        Thread.sleep(5);

        // Get the HTTP requests that have been intercepted
        XHR[] interceptedXHR = MockAPI
                .getInterceptedXHR("localhost", 8001, "/services/postservice");

        // Verify that the intercepted HTTP request is the one we are looking
        // for by checking its content
        Assert.assertEquals("POST", interceptedXHR[0].getMethodType());
        Assert.assertEquals("/services/postservice", interceptedXHR[0].getUrl());
        Assert.assertTrue(interceptedXHR[0].getBody().contains("timestamp="));
        Assert.assertTrue(interceptedXHR[0].getBody().contains("text=POST+Example"));
    }

    @Test
    public void testUnRegisterMock() throws Exception {

        // Create object for autocomplete element
        InteractiveElement autocomplete = new InteractiveElement(".//*[@id=\"autocomplete\"]");

        // Set up the object that contains our response configuration
        Map<String, Object> configurations = new HashMap<String, Object>();
        configurations.put("requestPath", "/services/getlanguages");
        configurations.put("responseText", "[{\"label\":\"Java\"},{\"label\":\"Perl\"}]");
        configurations.put("contentType", "application/json");
        configurations.put("statusCode", "200");
        configurations.put("delayTime", "0");

        // Set up the response using the configuration that was just created
        MockAPI.setMockRespond("localhost", 8001, configurations);

        // Type into the autocomplete to trigger the event
        autocomplete.type("J");

        Element dropdown = new Element(".//ul[contains(@class, \"ui-autocomplete\")]");
        dropdown.waitForVisible();

        List<WebElement> elements = ewd.findElements(By
                .xpath(".//ul[contains(@class, \"ui-autocomplete\")]/li"));

        autocomplete.getWebElement().clear();

        // Verify the dropdown elements
        Assert.assertEquals("Java", elements.get(0).getText());
        Assert.assertEquals("Perl", elements.get(1).getText());

        // Unregister this request so web-server.js no longer responds to it
        MockAPI.unRegisterMock("localhost", 8001, "/services/getlanguages");

        // Trigger event again
        autocomplete.type("J");

        // Verify that the dropdown no longer appears now that there
        // is no response
        Assert.assertEquals(false, !dropdown.isElementPresent());

    }

    @AfterClass
    public static void tearDown() {
        ewd.close();
    }
}
</code>
</pre>
			<br>For this to work, you must first start up MSL Server on port 8001(as described above) and, if you want to see what it is doing, you can turn on debug mode as is shown in the example above. 
			Once the server is up and running, you should be able to execute the test to see MSL Server in action using HtmlUnit.<br>

			<br>If you would like to have the test execute against your favorite browser or change any other ExtWebDriver options,
			you will need to include a properties file as shown in the <a href="http://finraos.github.io/JTAF-ExtWebDriver/clientproperties.html">Client Properties</a> page.
			  </div>
			</div>
		  </div>
		  
		  <div class="panel panel-default">
			<div class="panel-heading">
			  <h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
				  Browser Client
				</a>
			  </h4>
			</div>
			<div id="collapseTwo" class="panel-collapse collapse">
			  <div class="panel-body">
				Browser client can be used when you want to execute your test script on the browser (for instance mocha, jasmine tests).
				<br><br>To use this client, simply add <a href="http://cdnjs.cloudflare.com/ajax/libs/msl-client-browser/1.0.0/mockapi-browser.min.js">mockapi-browser.min.js</a> to your HTML.
				<div>
      				<pre class="prettyprint"><code>&lt;script src="http://cdnjs.cloudflare.com/ajax/libs/msl-client-browser/1.0.0/mockapi-browser.min.js"&gt;</code></pre>
				</div>
				<br>
				<b>(Full documentation with example coming soon!)</b>
			  </div>
			</div>
		  </div>
		</div>
	  	
	  	
	  <hr>
	  
	 	<footer>
    		<p>MSL project is released under <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank"><b>Apache License 2.0</b></a></p>
	    	<p>&copy; Copyright 2014 MSL Contributors</p>
    	</footer>
    </div><!-- /container -->
</body></html>
